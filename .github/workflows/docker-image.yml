name: Mirror Keycloak

on:
  workflow_dispatch: # avvio manuale
  schedule:
    - cron: '0 0 * * 0' # ogni domenica a mezzanotte

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  mirror:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log into GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Solo Keycloak in questo progetto
      - name: Define images
        run: |
          echo "IMAGES=keycloak/keycloak:latest" >> $GITHUB_ENV

      - name: Mirror Keycloak with version tag
        run: |
          for IMAGE in $IMAGES; do
            echo "Importing $IMAGE ..."

            BASE_NAME="${IMAGE%%:*}"
            SRC_TAG="${IMAGE##*:}"

            # Scarica sempre l'ultima versione (latest)
            docker pull "$BASE_NAME:$SRC_TAG"

            # 1) Prova a ricavare la versione dalle label OCI
            VERSION=$(docker inspect --format '{{ index .Config.Labels "org.opencontainers.image.version" }}' "$BASE_NAME:$SRC_TAG" 2>/dev/null || true)

            if [ -z "$VERSION" ] || [ "$VERSION" = "<no value>" ]; then
              VERSION=$(docker inspect --format '{{ index .Config.Labels "version" }}' "$BASE_NAME:$SRC_TAG" 2>/dev/null || true)
            fi

            # 2) Se Ã¨ vuota o "latest", chiedila al container
            if [ -z "$VERSION" ] || [ "$VERSION" = "<no value>" ] || [ "$VERSION" = "latest" ]; then
              # Usiamo l'entrypoint kc.sh con --version (es: "Keycloak 26.4.5")
              VERSION=$(docker run --rm "$BASE_NAME:$SRC_TAG" --version 2>/dev/null | \
                awk '{for (i=1;i<=NF;i++) if ($i ~ /^[0-9]+\.[0-9.]+$/) {print $i; exit}}' || true)
            fi

            # 3) Fallback finale
            if [ -z "$VERSION" ] || [ "$VERSION" = "<no value>" ]; then
              VERSION="$SRC_TAG"
            fi

            echo "Detected version for $BASE_NAME:$SRC_TAG -> $VERSION"

            NAME=$(echo "$BASE_NAME" | sed 's|/|-|g' | tr '[:upper:]' '[:lower:]')
            TARGET_VERSION=$(echo "${REGISTRY}/${IMAGE_NAME}/${NAME}:${VERSION}" | tr '[:upper:]' '[:lower:]')
            TARGET_LATEST=$(echo "${REGISTRY}/${IMAGE_NAME}/${NAME}:latest" | tr '[:upper:]' '[:lower:]')

            # Tag versionato
            docker tag "$BASE_NAME:$SRC_TAG" "$TARGET_VERSION"
            docker push "$TARGET_VERSION"
            echo "Pushed $TARGET_VERSION"

            # (Opzionale ma comodo) tag latest sul tuo registry
            docker tag "$BASE_NAME:$SRC_TAG" "$TARGET_LATEST"
            docker push "$TARGET_LATEST"
            echo "Pushed $TARGET_LATEST"
          done
