name: securest-keycloak

on:
  workflow_dispatch: # avvio manuale (puoi aggiungere anche schedule se vuoi)

permissions:
  contents: read
  packages: write   # serve per pushare il tag :securest su GHCR

jobs:
  securest:
    runs-on: ubuntu-latest
    env:
      IMAGE_BASE: ghcr.io/cytrix-italia/keycloak/keycloak-keycloak

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 1) Decidi quali TAG vuoi confrontare
      #    (qui è hardcoded, ma puoi generarlo dopo il mirroring)
      - name: Define tags to check
        run: |
          echo 'TAGS="26.0.0 26.0.1 26.0.2"' >> $GITHUB_ENV

      # 2) Installa jq e trivy CLI
      - name: Install jq and Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          TRIVY_VERSION=0.55.0
          wget -q https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz
          tar zxvf trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz
          sudo mv trivy /usr/local/bin/

      # 3) Scansiona tutti i tag e scegli il più "sicuro"
      - name: Scan tags and apply :securest
        run: |
          BEST_TAG=""
          BEST_SCORE=""

          for TAG in $TAGS; do
            IMAGE="${IMAGE_BASE}:${TAG}"
            echo ">>> Scanning ${IMAGE}..."

            # Assicurati di avere l'immagine in locale
            docker pull "$IMAGE"

            # Scansione Trivy in JSON
            trivy image \
              --severity CRITICAL,HIGH,MEDIUM \
              --format json \
              --timeout 30m \
              --output "trivy-${TAG}.json" \
              "$IMAGE"

            # Conta le vulnerabilità CRITICAL/HIGH/MEDIUM
            COUNT=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH" or .Severity=="MEDIUM")] | length' "trivy-${TAG}.json")

            echo "Tag ${TAG} -> ${COUNT} vulnerabilità (CRIT/HIGH/MED)"

            # Se è il primo o è migliore del migliore finora -> aggiorna BEST
            if [ -z "$BEST_SCORE" ] || [ "$COUNT" -lt "$BEST_SCORE" ]; then
              BEST_SCORE="$COUNT"
              BEST_TAG="$TAG"
            fi
          done

          echo ">>> Tag più \"sicuro\": ${BEST_TAG} con ${BEST_SCORE} vulnerabilità"

          if [ -z "$BEST_TAG" ]; then
            echo "Nessun tag valutato, esco con errore."
            exit 1
          fi

          # 4) Applica e pusha il tag :securest
          SECUREST_IMAGE="${IMAGE_BASE}:securest"
          SOURCE_IMAGE="${IMAGE_BASE}:${BEST_TAG}"

          echo "Tagging ${SOURCE_IMAGE} come ${SECUREST_IMAGE}..."
          docker tag "$SOURCE_IMAGE" "$SECUREST_IMAGE"
          docker push "$SECUREST_IMAGE"
          echo "Pushed ${SECUREST_IMAGE}"
